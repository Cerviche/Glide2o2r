**Rice (Glide) âžœ o2r (NextGen) Format for Ship of Harkinian**

## ðŸ“˜ Project Description
This project provides a fully automated, **content-aware conversion pipeline** for converting Ocarina of Time community texture packs from the legacy Rice / Glide system into the modern `.o2r` texture format used by **Ship of Harkinian (SoH)**.

Rather than relying on filenames or metadata, the pipeline uses **perceptual image hashing** and **distance-based matching** to identify equivalent textures by visual content. This allows accurate conversion even when filenames differ, metadata is missing, or textures are reused across multiple game assets.

The result is a fast, repeatable, and safe workflow that preserves decades of community texture work and makes it usable in modern ports.

> **ðŸ“¦ Latest Beta Build:**
> [Download via Google Drive](https://drive.google.com/file/d/1Gm8CRkofhqR_LDmafD49xW0llJPEPfc9/view)

---

## ðŸŽ¯ Key Features
* âš¡ **Three-stage pipeline:** Hash once, map many times, convert repeatedly.
* ðŸš€ **GPU-accelerated mapping (optional):** Reduces processing time from hours to seconds.
* ðŸ” **Duplicate-aware:** Correctly handles textures reused across many assets.
* ðŸŽšï¸ **Quality-based matching:** Weighted distance + confidence scoring.
* ðŸŽ­ **Alpha-aware matching:** Transparency is treated correctly to avoid visual glitches.
* ðŸ”’ **Safe by design:** Original texture packs are never modified.
* ðŸ“ **Rich reporting:** Generates CSV + JSON outputs with detailed statistics.
* ðŸ” **Fast experimentation:** Cached hashes make remapping instant.

---

## ðŸ“ Texture Formats Explained

### ðŸ§© Rice / Glide Format (Legacy)
*Used by emulators such as Mupen64Plus and Project64 (GlideN64).*

* **Filenames:** Hash-based (e.g., `THE_LEGEND_OF_ZELDA#92C1F51C#4#1_rgb.png`)
* **Lookup:** Based on N64 RAM hashing
* **Structure:** Flat directory structure
* **Context:** No semantic relationship between filename and in-game asset

### ðŸ—‚ï¸ o2r Format (Modern)
*Used by Ship of Harkinian.*

* **Filenames:** Human-readable, structured (e.g., `objects/gameplay_keep/gEffBombExplosion1Tex.png`)
* **Lookup:** Loaded directly by file path
* **Structure:** Hierarchical directory structure mirrors game assets
* **Context:** One texture may legitimately exist in many locations

---

## ðŸš€ Pipeline Overview

### ðŸ§  Step 1: `hash.py`
**Generate perceptual hashes (one-time per directory).**

Computes multiple perceptual hashes for each texture, automatically handles color and alpha channels, and outputs data to timestamped JSON files. This is the slowest step but only needs to run **once** per texture set.

```bash
python hash.py
```

**Outputs:**
* `glide_hashes_YYYYMMDD_HHMMSS.json`
* `soh_hashes_YYYYMMDD_HHMMSS.json`
* Hashing statistics and metadata

### ðŸ§­ Step 2: `map.py`
**Create cross-format texture mappings (repeatable).**

Matches Glide textures to o2r textures by visual similarity. It computes weighted distance, confidence scores, and alpha-channel compatibility. It is fully duplicate-aware and records all valid o2r destinations.

**GPU Acceleration:**
* **CPU-only:** Hours for large packs
* **GPU (CUDA):** Seconds for the same workload

```bash
python map.py
```

**Outputs:**
* `texture_map_YYYYMMDD_HHMMSS.csv`
* Matching statistics JSON (Distance, confidence, and duplicate analysis)

### ðŸ” Step 3: `convert.py`
**Convert texture packs into o2r format (repeatable).**

Uses a selected mapping CSV to copy textures into all required o2r destinations. It includes quality filtering by distance and confidence. **This never alters original texture packs.**

```bash
python convert.py
```

**Outputs:**
* `converted_YYYYMMDD_HHMMSS/`
* `conversion_report_*.csv`
* `conversion_report_*.json`

---

## ðŸ› ï¸ Installation

### Minimum Python dependencies:

```bash
pip install Pillow imagehash tqdm
```

### Optional (for GPU acceleration in `map.py`):
* **Hardware:** NVIDIA GPU
* **Software:** CUDA toolkit
* **Library:** `CuPy` (compatible with your CUDA version)

*Note: The pipeline runs fully on CPU if GPU support is unavailable.*

---

## ðŸ“‚ Directory Layout

```text
project/
â”œâ”€â”€ hash.py                     # Step 1: Hash calculator
â”œâ”€â”€ map.py                      # Step 2: Mapping generator (CPU/GPU)
â”œâ”€â”€ convert.py                  # Step 3: Texture converter
â”œâ”€â”€ glide_hashes_*.json         # Generated by hash.py
â”œâ”€â”€ soh_hashes_*.json           # Generated by hash.py
â”œâ”€â”€ texture_map_*.csv           # Generated by map.py
â”œâ”€â”€ converted_*/                # Generated by convert.py
â””â”€â”€ README.md
```

---

## ðŸ“Š Understanding Distance and Confidence

Perceptual hashing generates "fingerprints" of images. Differences are measured as **distance**.

| Distance | Interpretation |
| :--- | :--- |
| **0** | **Perfect match** (pixel-identical or effectively identical) |
| **1â€“2** | **Very high confidence** (recommended default) |
| **3â€“4** | **Acceptable**, but risk of false positives increases |
| **5+** | **Low confidence**, manual review strongly recommended |

**Confidence scores combine:**
1.  Multiple hash algorithms
2.  Alpha compatibility
3.  Relative distance quality

**Recommended workflow:** Start conservative, and increase thresholds only if coverage is insufficient.

---

## ðŸŽ® Context & Performance

### Why This Pipeline Exists
Most community texture packs were created for Rice/Glide-based emulators. To make them usable in Ship of Harkinian, three problems must be solved:
1.  Glide community textures must be matched to Glide reference textures.
2.  Those reference textures must be matched to o2r equivalents.
3.  Converted textures must be placed into **every** correct o2r destination.

### ðŸ”„ Duplicate Texture Handling
Many Ocarina of Time textures are reused across multiple assets. This pipeline detects duplicates during mapping, records all valid o2r paths, and copies textures to every required destination. Without this, converted texture packs would exhibit missing or inconsistent visuals.

### ðŸ“ˆ Real-World Performance
*Typical results on large packs:*

* **Hashing:** Minutes (one-time)
* **Mapping (CPU):** 2â€“6 hours
* **Mapping (GPU):** Seconds
* **Conversion:** Minutes
* **Match rate:** 40â€“60% depending on pack
* **Accuracy:** ~99% at conservative thresholds

---

## âš ï¸ Limitations and Considerations
* Not all community textures have modern equivalents.
* Aggressive thresholds increase false positives.
* Manual review is recommended for experimental runs.
* Rehashing is required if source textures change.

---

## ðŸ¤ Collaboration and Credits
This project exists to support the Ocarina of Time modding community by preserving legacy texture work, enabling modern engine compatibility, and eliminating thousands of hours of manual remapping.

**Credits:**
* Ryan Giovanazzi - Scripts / Project Creator
* Ian Skelsky - Consultation and texture dumping
* Ocarina Reloaded Team - Inspiration
* Ship of Harkinian Team - For SoH and the o2r format
* GlideN64 Developers - For the original technology that allowed texture packs
* Community Texture Artists - For their amazing artwork

**Links:**
* [Ryan Giovanazzi](https://github.com/cerviche/)
* [Ian Skelsky](https://github.com/IanSkelsky/)
* [Ship of Harkinian](https://github.com/HarbourMasters/)
* [Ocarina of Time HD Texture Project](https://github.com/GhostlyDark/)
* [GlideN64](https://github.com/gonetz/)

> *This pipeline is not just a converter. It is a compatibility layer between generations of tooling, ensuring community-created art remains usable as the platform evolves.*
